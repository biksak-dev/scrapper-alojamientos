<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comparador de Alojamientos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-slate-50 min-h-screen p-4 font-sans text-slate-800">

    <div class="max-w-6xl mx-auto">
        <header class="mb-8 text-center mt-6">
            <h1 class="text-4xl font-extrabold text-blue-900 tracking-tight uppercase drop-shadow-sm">
                <i class="fas fa-plane-departure mr-3 text-blue-500"></i>Despedida Anzola
            </h1>
            <p class="text-slate-500 text-sm mt-2 font-medium">Comparador de costos y alojamientos</p>
        </header>

        <div class="bg-white rounded-xl shadow-lg p-6 mb-8 border border-slate-100 sticky top-4 z-50">
            <div class="flex flex-col md:flex-row gap-6 items-end">
                
                <div class="w-full relative">
                    <label class="block text-xs font-bold text-slate-400 uppercase mb-2 ml-1">Enlace (Booking / Airbnb)</label>
                    <div class="relative">
                        <i class="fas fa-link absolute left-4 top-3.5 text-slate-300"></i>
                        <input type="text" id="urlInput" placeholder="Pega el link aquí..." 
                               class="w-full pl-10 pr-4 py-3 bg-slate-50 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:bg-white transition text-sm shadow-inner">
                    </div>
                </div>
                
                <div class="w-full md:w-64 bg-slate-50 p-3 rounded-lg border border-slate-100">
                    <div class="flex justify-between items-center mb-2">
                        <label class="text-xs font-bold text-slate-400 uppercase">Grupo</label>
                        <span class="text-xs font-bold bg-blue-100 text-blue-700 px-2 py-1 rounded">
                            <span id="sliderDisplay">2</span> Personas
                        </span>
                    </div>
                    <input type="range" id="peopleSlider" min="1" max="15" value="2" 
                           class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-blue-600 hover:accent-blue-500 transition"
                           oninput="updateSlider(this.value)">
                </div>

                <button onclick="startScraping()" id="scrapeBtn" 
                        class="w-full md:w-auto bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-lg transition shadow-md hover:shadow-lg flex items-center justify-center gap-2 whitespace-nowrap">
                    <i class="fas fa-search-plus"></i> Analizar
                </button>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-xl overflow-hidden border border-slate-100 min-h-[300px]">
            <table class="w-full text-left border-collapse">
                <thead class="bg-slate-800 text-white text-xs uppercase tracking-wider">
                    <tr>
                        <th class="p-4 font-semibold">Alojamiento</th>
                        <th class="p-4 font-semibold hidden md:table-cell">Tipo</th>
                        <th class="p-4 font-semibold hidden md:table-cell">Ubicación</th>
                        <th class="p-4 text-center font-semibold">Piscina</th>
                        <th class="p-4 text-right font-semibold">Total</th>
                        <th class="p-4 text-right bg-blue-900 w-32 font-semibold">x Persona</th>
                        <th class="p-4 text-center w-12"></th>
                    </tr>
                </thead>
                <tbody id="resultsBody" class="text-sm divide-y divide-slate-100">
                    </tbody>
            </table>
            
            <div id="loadingState" class="hidden flex flex-col items-center justify-center py-16 text-blue-600 bg-blue-50/30">
                <i class="fas fa-circle-notch fa-spin text-3xl mb-3"></i>
                <p class="font-semibold animate-pulse">Analizando precios...</p>
            </div>
            
            <div id="emptyState" class="flex flex-col items-center justify-center py-20 text-slate-300">
                <i class="fas fa-clipboard-list text-6xl mb-4 opacity-20"></i>
                <p>Pega un link para comenzar.</p>
            </div>
        </div>
    </div>

    <script>
        const urlInput = document.getElementById('urlInput');
        const slider = document.getElementById('peopleSlider');
        const sliderDisplay = document.getElementById('sliderDisplay');
        const resultsBody = document.getElementById('resultsBody');
        const emptyState = document.getElementById('emptyState');
        const loadingState = document.getElementById('loadingState');
        const scrapeBtn = document.getElementById('scrapeBtn');

        // Formato moneda Colombia/Dólar
        const moneyFormatter = new Intl.NumberFormat('es-CO', { 
            style: 'currency', currency: 'USD', maximumFractionDigits: 0 
        });

        function updateSlider(val) {
            sliderDisplay.innerText = val;
            recalculateAll(val);
        }

        async function startScraping() {
            const url = urlInput.value;
            if (!url) return alert("Por favor ingresa un link.");

            // UI
            emptyState.classList.add('hidden');
            loadingState.classList.remove('hidden');
            scrapeBtn.disabled = true;
            scrapeBtn.classList.add('opacity-50', 'cursor-not-allowed');

            try {
                // Fetch relativo a /scrape (funciona en cualquier dominio)
                const response = await fetch('/scrape', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url })
                });

                const data = await response.json();
                if (data.error) throw new Error(data.error);

                addResultRow(data);
                urlInput.value = '';

            } catch (err) {
                alert("Error: " + err.message);
                if(resultsBody.children.length === 0) emptyState.classList.remove('hidden');
            } finally {
                loadingState.classList.add('hidden');
                scrapeBtn.disabled = false;
                scrapeBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }

        function addResultRow(data) {
            const people = slider.value;
            const rowId = 'row-' + Date.now();
            const tr = document.createElement('tr');
            tr.id = rowId;
            tr.className = "hover:bg-blue-50 transition group bg-white";
            tr.dataset.total = data.totalPrice;

            const pp = data.totalPrice > 0 ? data.totalPrice / people : 0;
            const ppDisplay = pp > 0 ? moneyFormatter.format(pp) : "---";
            const totalDisplay = data.totalPrice > 0 ? moneyFormatter.format(data.totalPrice) : "0";

            tr.innerHTML = `
                <td class="p-4">
                    <a href="${data.url}" target="_blank" class="font-bold text-slate-700 group-hover:text-blue-600 transition line-clamp-2" title="${data.title}">
                        ${data.title.replace('Booking.com', '').substring(0, 40)}...
                    </a>
                </td>
                <td class="p-4 hidden md:table-cell"><span class="bg-slate-100 text-slate-500 px-2 py-1 rounded text-xs font-bold uppercase">${data.type}</span></td>
                <td class="p-4 hidden md:table-cell text-slate-500"><i class="fas fa-map-marker-alt text-red-400 mr-1"></i>${data.location.substring(0, 20)}</td>
                <td class="p-4 text-center">
                    ${data.hasPool === 'Sí' 
                        ? '<span class="inline-flex items-center gap-1 px-2 py-1 rounded-full bg-emerald-100 text-emerald-700 font-bold text-xs"><i class="fas fa-water"></i> Sí</span>' 
                        : '<span class="text-slate-300">-</span>'}
                </td>
                <td class="p-4 text-right font-mono font-bold text-slate-700">${totalDisplay}</td>
                <td class="p-4 text-right bg-blue-50/50 text-blue-700 font-bold font-mono text-lg pp-value">${ppDisplay}</td>
                <td class="p-4 text-center">
                    <button onclick="document.getElementById('${rowId}').remove()" class="text-slate-300 hover:text-red-500 transition p-2">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                </td>
            `;
            resultsBody.appendChild(tr);
        }

        function recalculateAll(people) {
            document.querySelectorAll('#resultsBody tr').forEach(row => {
                const total = parseFloat(row.dataset.total);
                const cell = row.querySelector('.pp-value');
                if (total > 0) cell.innerText = moneyFormatter.format(total / people);
            });
        }
    </script>
</body>
</html>